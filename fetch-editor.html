<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Request Editor</title>
    <style>
        /* Layout and Container */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 24px;
            font-weight: 300;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        /* Section Styles */
        .input-section, .editor-section, .output-section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

      /* Form Elements */
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

      /* Buttons */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

       /* Collapsible Elements */
        .collapsible {
            background: #f1f1f1;
            color: #333;
            cursor: pointer;
            padding: 12px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: 500;
            border-radius: 4px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }

        .collapsible:hover {
            background: #e8e8e8;
        }

        .collapsible::after {
            content: 'â–¼';
            float: right;
            transition: transform 0.3s;
        }

        .collapsible.active::after {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.show {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }

        /* Editor Components */
        .editor-fields {
            background: white;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e1e8ed;
        }

        .headers-editor {
            margin-bottom: 15px;
        }

        .header-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .header-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-remove:hover {
            background: #c0392b;
        }

        .btn-add {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #229954;
        }

        /* Resizable Editors */
        .resizable-editor {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .resizable-editor > div:first-child {
            height: 100% !important;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, transparent 50%, #ccc 50%);
            cursor: se-resize;
            z-index: 10;
        }

        .resize-handle:hover {
            background: linear-gradient(135deg, transparent 50%, #999 50%);
        }

        /* Form Controls */
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            transition: color 0.2s;
        }

        .checkbox-label:hover {
            color: #333;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            vertical-align: top;
            margin-top: 2px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .radio-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            transition: color 0.2s;
        }

        .radio-label:hover {
            color: #333;
        }

        .radio-label input[type="radio"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            vertical-align: top;
            margin-top: 2px;
        }

        .explanatory-text {
            display: block;
            color: #666;
            font-weight: normal;
            font-size: 12px;
            line-height: 1.4;
            margin-top: 3px;
        }

        .form-explanation {
            display: block;
            color: #666;
            font-weight: normal;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 8px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fetch Request Editor</h1>
            <p>Paste and modify fetch requests from browser DevTools</p>
        </header>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">Input</h2>
                
                <div class="form-group">
                    <label for="fetchInput">Paste Fetch Request:</label>
                    <div class="resizable-editor" style="height: 200px;">
                        <div id="fetchInput"></div>
                        <div class="resize-handle" data-target="fetchInput"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="parseFetchRequest()">Parse Request</button>
                    <button class="btn-secondary" onclick="clearInput()">Clear</button>
                    <button class="btn-secondary" onclick="loadExample()">Load Example</button>
                </div>
            </div>

            <div class="editor-section" id="editorSection" style="display: none;">
                <h2 class="section-title">Edit Request</h2>
                
                <div class="form-group">
                    <label for="methodSelect">Method:</label>
                    <select id="methodSelect">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                        <option value="HEAD">HEAD</option>
                        <option value="OPTIONS">OPTIONS</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="urlInput">URL:</label>
                    <input type="text" id="urlInput" placeholder="https://api.example.com/endpoint">
                </div>

                <div class="form-group">
                    <button class="collapsible" onclick="toggleHeaders()">Headers</button>
                    <div class="collapsible-content" id="headersContainer">
                        <div class="headers-editor" id="headersEditor">
                            <div class="header-row">
                                <input type="text" placeholder="Header name" class="header-name">
                                <input type="text" placeholder="Header value" class="header-value">
                                <button class="btn-remove" onclick="removeHeaderRow(this)">Remove</button>
                            </div>
                        </div>
                        <button class="btn-add" onclick="addHeaderRow()">Add Header</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bodyInput">Body (JSON):</label>
                    <div class="resizable-editor" style="height: 150px;">
                        <div id="bodyInput"></div>
                        <div class="resize-handle" data-target="bodyInput"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Response Handling:</label>
                    <small class="form-explanation">Choose how to parse the response body</small>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="responseType" value="json" checked>
                            <div>
                                <div>JSON (response.json())</div>
                                <small class="explanatory-text">Parse response as JSON object</small>
                            </div>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="responseType" value="text">
                            <div>
                                <div>Text (response.text())</div>
                                <small class="explanatory-text">Parse response as plain text</small>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="collectResponses">
                        <div>
                            <div>Collect requests/responses</div>
                            <small class="explanatory-text">Store multiple requests/responses in an array for batch processing</small>
                        </div>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="enableConsoleSave">
                        <div>
                            <div>Enable console.save</div>
                            <small class="explanatory-text">Add console.save() function to download data as JSON files</small>
                        </div>
                    </label>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="generateCode()">Generate Code</button>
                    <button class="btn-secondary" onclick="resetEditor()">Reset</button>
                </div>
            </div>

            <div class="output-section">
                <h2 class="section-title">Output</h2>
                
                <div class="form-group">
                    <label for="codeOutput">Generated JavaScript:</label>
                    <div class="resizable-editor" style="height: 300px;">
                        <div id="codeOutput"></div>
                        <div class="resize-handle" data-target="codeOutput"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="copyCode()">Copy Code</button>
                    <button class="btn-secondary" onclick="clearOutput()">Clear Output</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        let currentRequest = {
            method: 'GET',
            url: '',
            headers: {},
            body: ''
        };

        // Monaco Editor instances
        let inputEditor, bodyEditor, outputEditor;
        
        // Fallback mode flags
        let monacoLoaded = false;
        let monacoTimeout;
        let fallbackMode = false;

        // Set up Monaco Editor loading timeout and error handling
        monacoTimeout = setTimeout(() => {
            if (!monacoLoaded) {
                enableFallbackMode();
            }
        }, 5000);
        
        // Error handling for Monaco script loading
        const monacoScript = document.querySelector('script[src*="monaco-editor"]');
        if (monacoScript) {
            monacoScript.addEventListener('error', () => {
                enableFallbackMode();
            });
        }
        
        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
        require(['vs/editor/editor.main'], function() {
            clearTimeout(monacoTimeout);
            monacoLoaded = true;
            if (fallbackMode) return; // Don't initialize if fallback already active
            // Initialize input editor (JavaScript)
            inputEditor = monaco.editor.create(document.getElementById('fetchInput'), {
                value: '',
                language: 'javascript',
                theme: 'vs',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                automaticLayout: false
            });

            // Initialize body editor (JSON)
            bodyEditor = monaco.editor.create(document.getElementById('bodyInput'), {
                value: '',
                language: 'json',
                theme: 'vs',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                automaticLayout: false
            });

            // Initialize output editor (JavaScript)
            outputEditor = monaco.editor.create(document.getElementById('codeOutput'), {
                value: '',
                language: 'javascript',
                theme: 'vs',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                automaticLayout: false,
                readOnly: false
            });

            // Setup resize functionality
            setupResizeHandles();
        });
        
        function enableFallbackMode() {
            fallbackMode = true;
            clearTimeout(monacoTimeout);
            showNotification('Monaco Editor failed to load. Using fallback editor.', 'warning');
            initializeFallbackEditors();
        }
        
        function initializeFallbackEditors() {
            const containers = ['fetchInput', 'bodyInput', 'codeOutput'];
            
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container && !container.classList.contains('fallback-active')) {
                    const textarea = document.createElement('textarea');
                    textarea.className = 'fallback-editor';
                    textarea.style.cssText = `
                        width: 100%;
                        height: 100%;
                        min-height: 200px;
                        padding: 12px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-family: 'Consolas', 'Monaco', monospace;
                        font-size: 14px;
                        resize: vertical;
                        background: white;
                    `;
                    
                    container.innerHTML = '';
                    container.appendChild(textarea);
                    container.classList.add('fallback-active');
                }
            });
            
            // Update global references to work with fallback editors
            inputEditor = {
                getValue: () => document.querySelector('#fetchInput textarea')?.value || '',
                setValue: (val) => { const el = document.querySelector('#fetchInput textarea'); if (el) el.value = val; },
                layout: () => {}
            };
            bodyEditor = {
                getValue: () => document.querySelector('#bodyInput textarea')?.value || '',
                setValue: (val) => { const el = document.querySelector('#bodyInput textarea'); if (el) el.value = val; },
                layout: () => {}
            };
            outputEditor = {
                getValue: () => document.querySelector('#codeOutput textarea')?.value || '',
                setValue: (val) => { const el = document.querySelector('#codeOutput textarea'); if (el) el.value = val; },
                layout: () => {}
            };
        }

        function setupResizeHandles() {
            const resizeHandles = document.querySelectorAll('.resize-handle');
            
            // Initial layout setup
            setTimeout(() => {
                if (inputEditor) inputEditor.layout();
                if (bodyEditor) bodyEditor.layout();
                if (outputEditor) outputEditor.layout();
            }, 100);
            
            resizeHandles.forEach(handle => {
                let isResizing = false;
                let startY = 0;
                let startHeight = 0;
                let container = handle.parentElement;
                let targetId = handle.getAttribute('data-target');
                let targetElement = document.getElementById(targetId);

                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startY = e.clientY;
                    startHeight = container.offsetHeight;
                    document.body.style.cursor = 'se-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    
                    const deltaY = e.clientY - startY;
                    const newHeight = Math.max(100, startHeight + deltaY);
                    
                    container.style.height = newHeight + 'px';
                    
                    // Refresh Monaco editor layout
                    setTimeout(() => {
                        if (targetId === 'fetchInput' && inputEditor) {
                            inputEditor.layout();
                        } else if (targetId === 'bodyInput' && bodyEditor) {
                            bodyEditor.layout();
                        } else if (targetId === 'codeOutput' && outputEditor) {
                            outputEditor.layout();
                        }
                    }, 0);
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    }
                });
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function parseFetchRequest() {
            const input = inputEditor.getValue().trim();
            
            if (!input) {
                showNotification('Please enter a fetch request', 'error');
                return;
            }

            try {
                // Reset current request
                currentRequest = {
                    method: 'GET',
                    url: '',
                    headers: {},
                    body: ''
                };

                // Try to parse as a fetch() call
                if (input.includes('fetch(')) {
                    parseFetchCall(input);
                } else {
                    // Try to parse as options object directly
                    try {
                        const options = JSON.parse(input);
                        parseOptionsObject(options);
                    } catch (e) {
                        throw new Error('Could not parse as fetch call or JSON object');
                    }
                }

                populateEditor();
                document.getElementById('editorSection').style.display = 'block';
                showNotification('Request parsed successfully!');
            } catch (error) {
                showNotification('Failed to parse fetch request: ' + error.message, 'error');
            }
        }

        function parseFetchCall(input) {
            // Extract URL from first parameter
            const urlMatch = input.match(/fetch\s*\(\s*["'`]([^"'`]+)["'`]/);
            if (urlMatch) {
                currentRequest.url = urlMatch[1];
            }

            // Find the JSON object after the comma and parse it
            const jsonMatch = input.match(/fetch\s*\([^,]*,\s*(\{[\s\S]*\})\s*\)/);
            if (jsonMatch) {
                try {
                    const options = JSON.parse(jsonMatch[1]);
                    console.log(options);
                    if (options.method) currentRequest.method = options.method.toUpperCase();
                    if (options.headers) currentRequest.headers = options.headers;
                    if (options.body) {
                        // Try to parse and format the body as JSON
                        try {
                            const parsedBody = JSON.parse(options.body);
                            currentRequest.body = JSON.stringify(parsedBody, null, 2);
                        } catch (e) {
                            // If it's not valid JSON, use as-is
                            currentRequest.body = options.body;
                        }
                    }
                } catch (e) {
                    throw new Error('Invalid JSON in fetch options');
                }
            }
        }

        function extractString(str) {
            str = str.trim();
            if ((str.startsWith('"') && str.endsWith('"')) || 
                (str.startsWith("'") && str.endsWith("'"))) {
                return str.slice(1, -1);
            }
            if (str.startsWith('`') && str.endsWith('`')) {
                return str.slice(1, -1);
            }
            return str;
        }

        function parseOptionsObject(options) {
            if (options.method) currentRequest.method = options.method.toUpperCase();
            if (options.headers) currentRequest.headers = options.headers;
            if (options.body) {
                // Try to parse and format the body as JSON
                try {
                    const parsedBody = JSON.parse(options.body);
                    currentRequest.body = JSON.stringify(parsedBody, null, 2);
                } catch (e) {
                    // If it's not valid JSON, use as-is
                    currentRequest.body = options.body;
                }
            }
        }

  
        function populateEditor() {
            document.getElementById('methodSelect').value = currentRequest.method;
            document.getElementById('urlInput').value = currentRequest.url;
            
            // Set language based on whether body is valid JSON
            if (!fallbackMode) {
                const isJSON = isValidJSON(currentRequest.body);
                const language = isJSON ? 'json' : 'plaintext';
                
                // Create new model with appropriate language
                const model = monaco.editor.createModel(currentRequest.body, language);
                bodyEditor.setModel(model);
            } else {
                bodyEditor.setValue(currentRequest.body);
            }

            // Clear and populate headers
            const headersEditor = document.getElementById('headersEditor');
            headersEditor.innerHTML = '';

            if (Object.keys(currentRequest.headers).length > 0) {
                Object.entries(currentRequest.headers).forEach(([key, value]) => {
                    addHeaderRow(key, value);
                });
            } else {
                addHeaderRow();
            }

            // Refresh body editor layout after content is set
            setTimeout(() => {
                if (bodyEditor) {
                    bodyEditor.layout();
                }
            }, 50);
        }

        function addHeaderRow(name = '', value = '') {
            const headersEditor = document.getElementById('headersEditor');
            const headerRow = document.createElement('div');
            headerRow.className = 'header-row';
            
            // Escape HTML attributes to prevent breaking the markup
            const escapeHtml = (str) => str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/\//g, '&#x2F;');
            
            headerRow.innerHTML = `
                <input type="text" placeholder="Header name" class="header-name" value="${escapeHtml(name)}">
                <input type="text" placeholder="Header value" class="header-value" value="${escapeHtml(value)}">
                <button class="btn-remove" onclick="removeHeaderRow(this)">Remove</button>
            `;
            headersEditor.appendChild(headerRow);
        }

        function removeHeaderRow(button) {
            const headerRows = document.querySelectorAll('.header-row');
            if (headerRows.length > 1) {
                button.parentElement.remove();
            } else {
                showNotification('At least one header row must remain', 'error');
            }
        }

        // Unescape HTML entities to get original values for code generation
        function unescapeHtml(str) {
            const div = document.createElement('div');
            div.innerHTML = str;
            return div.textContent || div.innerText || '';
        }

        function isValidJSON(str) {
            if (!str || str.trim() === '') {
                return false;
            }
            try {
                JSON.parse(str);
                return true;
            } catch (e) {
                return false;
            }
        }

        function generateCode() {
            try {
                // Collect form data
                currentRequest.method = document.getElementById('methodSelect').value;
                currentRequest.url = document.getElementById('urlInput').value.trim();
                currentRequest.body = bodyEditor.getValue().trim();

                // Collect headers
                currentRequest.headers = {};
                document.querySelectorAll('.header-row').forEach(row => {
                    const name = unescapeHtml(row.querySelector('.header-name').value.trim());
                    const value = unescapeHtml(row.querySelector('.header-value').value.trim());
                    if (name && value) {
                        currentRequest.headers[name] = value;
                    }
                });

                // Generate JavaScript code
                const code = generateFetchCode();
                outputEditor.setValue(code);
                showNotification('Code generated successfully!');
            } catch (error) {
                showNotification('Failed to generate code: ' + error.message, 'error');
            }
        }

        function generateFetchCode() {
            // Get checkbox states
            const collectMode = document.getElementById('collectResponses').checked;
            const saveMode = document.getElementById('enableConsoleSave').checked;
            
            // Get response type selection
            const responseType = document.querySelector('input[name="responseType"]:checked').value;
            
            let baseCode = '';
            let setupCode = '';
            let loopCode = '';
            
            // Console save setup code if enabled
            if (saveMode) {
                setupCode += getConsoleSaveCode() + '\n';
            }
            
            // Collection setup code if enabled
            if (collectMode) {
                setupCode += `const results = [];\n`;
            }
            
            // Build the fetch request code
            let fetchCode = `await fetch('${currentRequest.url}', {
  method: '${currentRequest.method}'`;

            if (Object.keys(currentRequest.headers).length > 0) {
                fetchCode += `,
  headers: {`;
                Object.entries(currentRequest.headers).forEach(([key, value], index) => {
                    // Escape single quotes in header values for valid JavaScript
                    const escapedValue = value.replace(/'/g, "\\'");
                    fetchCode += `
    '${key}': '${escapedValue}'`;
                    if (index < Object.keys(currentRequest.headers).length - 1) {
                        fetchCode += ',';
                    }
                });
                fetchCode += `
  }`;
            }

            if (currentRequest.body && (currentRequest.method !== 'GET' && currentRequest.method !== 'HEAD')) {
                // Check if body is already formatted JSON or needs to be stringified
                try {
                    const parsedBody = JSON.parse(currentRequest.body);
                    // If it's valid JSON, use the formatted version
                    fetchCode += `,
  body: JSON.stringify(${JSON.stringify(parsedBody, null, 4)})`;
                } catch (e) {
                    // If it's not valid JSON, use as string
                    fetchCode += `,
  body: ${JSON.stringify(currentRequest.body)}`;
                }
            }

            fetchCode += `
});`;

            // Handle collection mode or regular execution
            if (collectMode) {
                // Build the URL and body before the request in collectMode
                let setupCode = '';
                let hasBody = false;
                
                // Extract URL as a variable
                setupCode = `  const requestUrl = '${currentRequest.url}';\n`;
                
                if (currentRequest.body && (currentRequest.method !== 'GET' && currentRequest.method !== 'HEAD')) {
                    hasBody = true;
                    try {
                        const parsedBody = JSON.parse(currentRequest.body);
                        setupCode += `  const requestBody = JSON.stringify(${JSON.stringify(parsedBody, null, 4)});\n`;
                    } catch (e) {
                        setupCode += `  const requestBody = ${JSON.stringify(currentRequest.body)};\n`;
                    }
                } else {
                    setupCode += `  const requestBody = undefined;\n`;
                }
                
                // Rebuild the fetch code to use requestUrl and requestBody variables
                let collectionFetchCode = `await fetch(requestUrl, {
  method: '${currentRequest.method}'`;

                if (Object.keys(currentRequest.headers).length > 0) {
                    collectionFetchCode += `,
  headers: {`;
                    Object.entries(currentRequest.headers).forEach(([key, value], index) => {
                        // Escape single quotes in header values for valid JavaScript
                        const escapedValue = value.replace(/'/g, "\\'");
                        collectionFetchCode += `
    '${key}': '${escapedValue}'`;
                        if (index < Object.keys(currentRequest.headers).length - 1) {
                            collectionFetchCode += ',';
                        }
                    });
                    collectionFetchCode += `
  }`;
                }

                if (hasBody) {
                    collectionFetchCode += `,
  body: requestBody`;
                }

                collectionFetchCode += `
});`;
                
                loopCode += `${setupCode}  for (let i = 0; i < 1; i++) {
    console.log('start req', i);
    const response = ${collectionFetchCode}
    
    if (!response.ok) {
      throw new Error(\`HTTP error! status: \${response.status}\`);
    }
    
    const data = ${responseType === 'json' ? 'await response.json()' : 'await response.text()'};
    
    // Collect request/response data
    results.push({
      req: {
        url: requestUrl,
        body: requestBody
      },
      resp: {
        code: response.status,
        body: data
      }
    });
  }
  
  console.log('all done');`;
                
                if (saveMode) {
                    loopCode += `
  // Use console.save(results, 'responses.json') to save results if needed;`;
                }
                
                loopCode += `
  
  console.log('Collected results:', results);`;
                
            } else {
                // Regular (non-collection) mode
                loopCode += `  const response = ${fetchCode}
  
  if (!response.ok) {
    throw new Error(\`HTTP error! status: \${response.status}\`);
  }
  
  const data = ${responseType === 'json' ? 'await response.json()' : 'await response.text()'};
  console.log('Response:', data);`;
                
                if (saveMode) {
                    let bodyAssignment = 'undefined';
                    if (currentRequest.body) {
                        try {
                            const parsedBody = JSON.parse(currentRequest.body);
                            bodyAssignment = JSON.stringify(parsedBody, null, 4);
                        } catch (e) {
                            bodyAssignment = JSON.stringify(currentRequest.body);
                        }
                    }
                    
                    loopCode += `
  
  // Response data object available for saving
  const responseObj = {
    req: {
      url: '${currentRequest.url}',
      body: ${bodyAssignment}
    },
    resp: {
      code: response.status,
      body: data
    }
  };
  // Use console.save(responseObj, 'response.json') to save if needed;`;
                }
            }

            // Combine all parts and wrap in async function
            const fullCode = `async function makeRequest() {
  try {
${setupCode.split('\n').map(line => '    ' + line).join('\n')}
${loopCode}
${collectMode ? '    return results;' : '    return data;'}
  } catch (error) {
    console.error('Request failed:', error);
  }
}

fetch_mod_resp = await makeRequest();`;

            return fullCode;
        }

        function getConsoleSaveCode() {
            return `// Console.save implementation (only injects if not already defined)
if (typeof console.save === 'undefined') {
  (function(console){
    console.save = function(data, filename){
      if(!data) {
        console.error('Console.save: No data')
        return;
      }
      if(!filename) {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        filename = timestamp + '.json';
      }
      if(typeof data === "object"){
        data = JSON.stringify(data, undefined, 4)
      }
      var blob = new Blob([data], {type: 'text/json'}),
          e    = document.createEvent('MouseEvents'),
          a    = document.createElement('a')
      a.download = filename
      a.href = window.URL.createObjectURL(blob)
      a.dataset.downloadurl =  ['text/json', a.download, a.href].join(':')
      e.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
      a.dispatchEvent(e)
    }
  })(console);
  console.log('console.save() is now available. Use console.save(obj, "filename.json") to save data.');
}`;
        }

        function copyCode() {
            const code = outputEditor.getValue();
            if (!code) {
                showNotification('No code to copy', 'error');
                return;
            }

            // Check if clipboard API is available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showNotification('Code copied to clipboard!');
                }).catch(err => {
                    // Fallback to older method if clipboard API fails
                    fallbackCopyTextToClipboard(code);
                });
            } else {
                // Use fallback method for browsers that don't support clipboard API
                fallbackCopyTextToClipboard(code);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('Code copied to clipboard!');
                } else {
                    showNotification('Failed to copy code', 'error');
                }
            } catch (err) {
                showNotification('Failed to copy code', 'error');
            }

            document.body.removeChild(textArea);
        }

        function clearInput() {
            inputEditor.setValue('');
            document.getElementById('editorSection').style.display = 'none';
        }

        function clearOutput() {
            outputEditor.setValue('');
        }

        function resetEditor() {
            currentRequest = {
                method: 'GET',
                url: '',
                headers: {},
                body: ''
            };
            populateEditor();
            clearOutput();
        }

        function toggleHeaders() {
            const coll = document.querySelector('.collapsible');
            const content = document.getElementById('headersContainer');
            coll.classList.toggle('active');
            content.classList.toggle('show');
        }

        function loadExample() {
            const exampleContent = `fetch("http://localhost:8080/api", {
  "headers": {
    "accept": "*/*",
    "accept-language": "zh-CN,zh;q=0.9",
    "content-type": "application/json"
  },
  "body": "{\\"text\\":\\"11\\",\\"message\\":\\"222\\",\\"number\\":111,\\"option1\\":true,\\"option2\\":false}",
  "method": "POST",
  "mode": "cors",
  "credentials": "include"
});`;
            inputEditor.setValue(exampleContent);
            showNotification('Example loaded!');
        }

        // Initialize with one empty header row
        document.addEventListener('DOMContentLoaded', function() {
            addHeaderRow();
            
            // Add event listeners for checkboxes
            const collectCheckbox = document.getElementById('collectResponses');
            const saveCheckbox = document.getElementById('enableConsoleSave');
            
            collectCheckbox.addEventListener('change', function() {
                console.log('Collection mode:', this.checked);
            });
            
            saveCheckbox.addEventListener('change', function() {
                console.log('Console save mode:', this.checked);
            });
        });
    </script>
</body>
</html>