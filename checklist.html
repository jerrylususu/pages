<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÆÄÂçïÊ∏ÖÂçï</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            font-size: 16px;
        }
        @media (max-width: 600px) {
            body {
                margin: 10px auto;
                padding: 0 15px;
                font-size: 18px;
            }
            .next-item {
                margin: 15px auto;
                padding: 15px;
            }
            .next-button {
                padding: 15px 20px;
                font-size: 18px;
            }
            .checklist-item {
                padding: 12px;
            }
            .checklist-item input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }
            textarea {
                font-size: 16px;
            }
        }
        .checklist-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .checklist-item:hover {
            background: #e0e0e0;
        }
        .checklist-item.done {
            opacity: 0.7;
        }
        .checklist-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .edit-mode .checklist-item {
            cursor: move;
        }
        .edit-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .next-item {
            text-align: center;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            border-radius: 8px;
            background: #e6f3ff;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .next-item > div {
            margin: 0;
        }
        .next-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .next-button:hover {
            background-color: #45a049;
        }
        .delete-btn {
            margin-left: auto;
            color: red;
            cursor: pointer;
            display: none;
        }
        .edit-mode .delete-btn {
            display: block;
        }
        #counter {
            color: #666;
            margin: 10px 0;
        }
        .drag-over {
            border: 2px dashed #666;
        }
        body.dark-mode,
        body[data-theme="dark"] {
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }
        body.dark-mode .checklist-item,
        body[data-theme="dark"] .checklist-item {
            background: #2d2d2d !important;
        }
        body.dark-mode .next-item,
        body[data-theme="dark"] .next-item {
            background: #1a3045 !important;
        }
        body.light-mode,
        body[data-theme="light"] {
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        body.light-mode .checklist-item,
        body[data-theme="light"] .checklist-item {
            background: #f5f5f5 !important;
        }
        body.light-mode .next-item,
        body[data-theme="light"] .next-item {
            background: #e6f3ff !important;
        }
        body.dark-mode .next-button {
            background-color: #5cb85c;
        }
        body.dark-mode .next-button:hover {
            background-color: #4cae4c;
        }
        .theme-toggle {
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .completion-message {
            text-align: center;
            font-size: 18px;
            color: #4CAF50;
            margin: 40px 0;
        }
        body.dark-mode .completion-message {
            color: #5cb85c;
        }
        .list-header {
            margin-bottom: 20px;
        }
        .list-header h2 {
            margin: 0;
        }
        .list-note {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        body.dark-mode .list-note {
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="edit-controls">
            <div class="list-header">
                <h2 id="listTitle">Ê∏ÖÂçï</h2>
                <div id="listNote" class="list-note"></div>
            </div>
            <div>
                <button onclick="toggleEditMode()" id="editBtn">ÁºñËæë</button>
                <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
            </div>
        </div>
        <div id="counter"></div>
        <div id="checklist"></div>
        <div id="nextItem" class="next-item">
            <button onclick="completeAndContinue()" class="next-button">ÂÆåÊàêÂπ∂ÁªßÁª≠</button>
        </div>
    </div>

    <script>
        let items = [];
        let editMode = false;
        let dragItem = null;

        // ÂàùÂßãÂåñ
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const d = urlParams.get('d');
            
            // URLÂèÇÊï∞ d ÁöÑÊ†ºÂºè: Ê†áÈ¢ò~Â§áÊ≥®~‰ªªÂä°1|‰ªªÂä°2|‰ªªÂä°3
            // ‰æãÂ¶Ç: ?d=ÊàëÁöÑÊ∏ÖÂçï~ÊØèÊó•‰ªªÂä°~‰π∞Ëèú|Ê¥óË°£Êúç|ÂÜô‰Ωú‰∏ö
            // Ê†áÈ¢òÂíåÂ§áÊ≥®ÂèØÈÄâ,‰ªªÂä°‰πãÈó¥Áî®|ÂàÜÈöî
            if (d) {
                // Ëß£ÊûêÂéãÁº©Ê†ºÂºèÁöÑÊï∞ÊçÆ
                const parts = d.split('~');
                const title = parts[0] || 'Ê∏ÖÂçï';
                let note = '';
                let tasks = [];
                
                if (parts.length === 2) {
                    // Â¶ÇÊûúÂè™Êúâ‰∏§ÈÉ®ÂàÜÔºåÁ¨¨‰∫åÈÉ®ÂàÜÊòØ‰ªªÂä°ÂàóË°®
                    tasks = parts[1].split('|');
                } else if (parts.length >= 3) {
                    // Â¶ÇÊûúÊúâ‰∏âÈÉ®ÂàÜÊàñÊõ¥Â§öÔºåÁ¨¨‰∫åÈÉ®ÂàÜÊòØÂ§áÊ≥®ÔºåÁ¨¨‰∏âÈÉ®ÂàÜÊòØ‰ªªÂä°ÂàóË°®
                    note = parts[1];
                    tasks = parts[2].split('|');
                }
                
                document.getElementById('listTitle').textContent = title;
                document.getElementById('listNote').textContent = note ? `Â§áÊ≥®: ${note}` : '';
                
                items = tasks.map(text => ({
                    text,
                    done: false
                }));
            } else {
                items = [
                    { text: "‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰ªªÂä°", done: false },
                    { text: "Âè¶‰∏Ä‰∏™‰ªªÂä°", done: false },
                    { text: "ÁÇπÂáªÂè≥‰∏äËßíÁºñËæë", done: false }
                ];
            }
            render();

            // ‰∏ªÈ¢òÂàùÂßãÂåñ
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            } else if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑËÆæÁΩÆÔºå‰ΩøÁî®Á≥ªÁªüÂÅèÂ•Ω
                document.body.classList.add(prefersDark ? 'dark-mode' : 'light-mode');
            }
        }

        // Ê∏≤ÊüìÊ∏ÖÂçï
        function render() {
            const list = document.getElementById('checklist');
            const nextItemDiv = document.getElementById('nextItem');
            list.innerHTML = '';
            
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `checklist-item ${item.done ? 'done' : ''}`;
                div.draggable = editMode;
                
                if (!editMode) {
                    div.onclick = (e) => {
                        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ§çÈÄâÊ°ÜÊú¨Ë∫´Ôºå‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÂ§ÑÁêÜ
                        if (e.target.type !== 'checkbox') {
                            const checkbox = div.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                            toggleItem(index);
                        }
                    };
                }
                
                div.innerHTML = `
                    <input type="checkbox" ${item.done ? 'checked' : ''} 
                        onchange="toggleItem(${index})" ${editMode ? 'disabled' : ''}>
                    <span>${item.text}</span>
                `;
                
                list.appendChild(div);
            });

            // Êõ¥Êñ∞ËÆ°Êï∞Âô® - ‰ªÖÂú®ÈùûÁºñËæëÊ®°Âºè‰∏ãÊòæÁ§∫
            const counter = document.getElementById('counter');
            if (!editMode) {
                const doneCount = items.filter(item => item.done).length;
                counter.textContent = `ÂÆåÊàê: ${doneCount} / ${items.length}`;
                counter.style.display = 'block';
                updateDocumentTitle();
            } else {
                counter.style.display = 'none';
            }

            // Êõ¥Êñ∞‰∏ã‰∏Ä‰∏™ÂæÖÂäûÈ°π
            const nextItem = items.find(item => !item.done);
            if (!editMode) {
                if (nextItem) {
                    nextItemDiv.innerHTML = `
                        <div>‰∏ã‰∏ÄÈ°π:</div>
                        <div>${nextItem.text}</div>
                        <button onclick="completeNextItem()" class="next-button">ÂÆåÊàêÂπ∂ÁªßÁª≠</button>
                    `;
                } else {
                    nextItemDiv.innerHTML = `
                        <div class="completion-message">
                            ÊâÄÊúâÈ°πÁõÆÂùáÂ∑≤ÂÆåÊàê üéâ
                        </div>
                    `;
                }
            } else {
                nextItemDiv.innerHTML = '';
            }
        }

        // ÂàáÊç¢ÁºñËæëÊ®°Âºè
        function toggleEditMode() {
            editMode = !editMode;
            document.getElementById('editBtn').textContent = editMode ? '‰øùÂ≠ò' : 'ÁºñËæë';
            
            const checklistDiv = document.getElementById('checklist');
            const nextItemDiv = document.getElementById('nextItem');
            const titleElement = document.getElementById('listTitle');
            const noteElement = document.getElementById('listNote');
            const counter = document.getElementById('counter');
            
            if (editMode) {
                counter.style.display = 'none';
                
                // Ê∑ªÂä†Ê†áÈ¢òÂíå‰ΩúËÄÖÁºñËæëÊ°Ü
                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.value = titleElement.textContent;
                titleInput.style.fontSize = '1.5em';
                titleInput.style.marginBottom = '10px';
                titleInput.style.width = '100%';
                
                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.value = noteElement.textContent.replace('Â§áÊ≥®: ', '');
                noteInput.placeholder = 'Â§áÊ≥®ÔºàÂèØÈÄâÔºâ';
                noteInput.style.width = '100%';
                noteInput.style.marginBottom = '20px';
                
                titleElement.replaceWith(titleInput);
                noteElement.replaceWith(noteInput);
                
                // ÂàáÊç¢Âà∞ÁºñËæëÊ®°ÂºèÔºöÊòæÁ§∫ÊñáÊú¨Ê°Ü
                const textarea = document.createElement('textarea');
                textarea.style.width = '100%';
                textarea.style.height = '200px';
                textarea.value = items.map(item => item.text).join('\n');
                checklistDiv.innerHTML = '';
                checklistDiv.appendChild(textarea);
                nextItemDiv.style.display = 'none';
            } else {
                counter.style.display = 'block';
                
                // ‰øùÂ≠òÁºñËæëÂÜÖÂÆπ
                const titleInput = document.querySelector('input[type="text"]');
                const noteInput = document.querySelector('input[placeholder="Â§áÊ≥®ÔºàÂèØÈÄâÔºâ"]');
                const textarea = checklistDiv.querySelector('textarea');
                
                if (textarea) {
                    const lines = textarea.value.split('\n').filter(line => line.trim());
                    items = lines.map(text => ({ text, done: false }));
                    
                    // ÂéãÁº©Êï∞ÊçÆÊ†ºÂºè
                    const title = titleInput.value;
                    const note = noteInput.value;
                    const tasks = items.map(item => item.text).join('|');
                    
                    // Ê†πÊçÆÊòØÂê¶Êúâ‰ΩúËÄÖÊûÑÂª∫Êï∞ÊçÆÂ≠óÁ¨¶‰∏≤
                    const compressedData = note 
                        ? `${title}~${note}~${tasks}`
                        : `${title}~${tasks}`;
                    
                    // Êõ¥Êñ∞URLÔºåÂè™‰ΩøÁî®‰∏Ä‰∏™Êü•ËØ¢ÂèÇÊï∞
                    const newUrl = `${window.location.pathname}?d=${encodeURIComponent(compressedData)}`;
                    window.history.pushState({}, '', newUrl);
                    
                    // ÊÅ¢Â§çÊ†áÈ¢òÂíå‰ΩúËÄÖÊòæÁ§∫
                    const newTitle = document.createElement('h2');
                    newTitle.id = 'listTitle';
                    newTitle.textContent = titleInput.value;
                    
                    const newNote = document.createElement('div');
                    newNote.id = 'listNote';
                    newNote.className = 'list-note';
                    newNote.textContent = noteInput.value ? `Â§áÊ≥®: ${noteInput.value}` : '';
                    
                    titleInput.replaceWith(newTitle);
                    noteInput.replaceWith(newNote);
                    
                    alert('‰øùÂ≠òÊàêÂäüÔºÅ\n\nËØ∑‰ªéÂú∞ÂùÄÊ†èÂ§çÂà∂Êñ∞ÁöÑURL‰ª•ÂàÜ‰∫´ÊÇ®ÁöÑÊ∏ÖÂçï„ÄÇ');
                }
                render();
                updateDocumentTitle();
                nextItemDiv.style.display = 'block';
            }
        }

        // ÂàáÊç¢È°πÁõÆÁä∂ÊÄÅ
        function toggleItem(index) {
            items[index].done = !items[index].done;
            render();
        }

        // ÂÆåÊàê‰∏ã‰∏Ä‰∏™ÂæÖÂäûÈ°π
        function completeNextItem() {
            const index = items.findIndex(item => !item.done);
            if (index !== -1) {
                items[index].done = true;
                render();
            }
        }


        // ‰øÆÊîπ‰∏ªÈ¢òÂàáÊç¢ÂáΩÊï∞
        function toggleTheme() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Ê∑ªÂä†Êñ∞ÂáΩÊï∞Êù•Êõ¥Êñ∞ÊñáÊ°£Ê†áÈ¢ò
        function updateDocumentTitle() {
            const title = document.getElementById('listTitle').textContent;
            const doneCount = items.filter(item => item.done).length;
            const totalCount = items.length;
            document.title = `${title} (${doneCount}/${totalCount})`;
        }

        // ÂêØÂä®Â∫îÁî®
        init();
    </script>
</body>
</html>
